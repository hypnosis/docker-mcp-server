# Refactoring: Profile-Based Docker Client Pool

> **ะฆะตะปั:** ะะธะณัะธัะพะฒะฐัั ั `getDockerClient(sshConfig)` ะฝะฐ `getDockerClientForProfile(profileName)` ะดะปั ะฟัะฐะฒะธะปัะฝะพะณะพ ะบััะธัะพะฒะฐะฝะธั SSH ััะฝะฝะตะปะตะน

**ะะฐัะฐ ัะพะทะดะฐะฝะธั:** 2026-01-12  
**ะะตััะธั:** 1.3.2 โ 1.4.0  
**ะัะธะพัะธัะตั:** HIGH (Performance + Bug Fix)  
**ะกัะฐััั:** ๐ ะะะะะะะะะะะะ

---

## ๐ ะัะพะฑะปะตะผะฐ

### ะขะตะบััะฐั ะฐััะธัะตะบัััะฐ

```
MCP Tool โ resolveSSHConfig(args) โ SSHConfig โ Manager(sshConfig) โ getDockerClient(sshConfig)
                                                                            โ
                                                            Singleton ะบัั ะฟะพ HOST (ะะะ!)
```

### ะะฐะณ: ะะตะฟัะฐะฒะธะปัะฝะพะต ะบััะธัะพะฒะฐะฝะธะต

```typescript
// docker-client.ts:471-475
const shouldRecreate = !dockerClientInstance || 
  (sshConfig !== undefined && (
    dockerClientInstance.isRemote !== requestedIsRemote ||
    dockerClientInstance.getSSHHost() !== requestedHost  // โ ะขะะะฌะะ HOST!
  ));
```

**ะัะพะฑะปะตะผะฐ:** ะะฒะฐ ะฟัะพัะธะปั ั ะพะดะฝะธะผ `host`, ะฝะพ ัะฐะทะฝัะผะธ `privateKeyPath` ะธัะฟะพะปัะทััั ะะะะ ะบะปะธะตะฝั!

### ะัะธะผะตั ะฑะฐะณะฐ:

```json
{
  "profiles": {
    "prod-admin": {
      "host": "prod.example.com",
      "privateKeyPath": "~/.ssh/id_rsa_admin"  // โ ะะดะผะธะฝัะบะธะน ะบะปัั
    },
    "prod-readonly": {
      "host": "prod.example.com",
      "privateKeyPath": "~/.ssh/id_rsa_readonly"  // โ Read-only ะบะปัั
    }
  }
}
```

**ะะฐะณ:**
1. ะะตัะฒัะน ะฒัะทะพะฒ: `profile: "prod-admin"` โ ัะพะทะดะฐะตั ััะฝะฝะตะปั ั ะฐะดะผะธะฝัะบะธะผ ะบะปััะพะผ โ
2. ะัะพัะพะน ะฒัะทะพะฒ: `profile: "prod-readonly"` โ ะฟะตัะตะธัะฟะพะปัะทัะตั ััะฝะฝะตะปั ั ะฐะดะผะธะฝัะบะธะผ ะบะปััะพะผ! โ
3. ะะตะทัะปััะฐั: Read-only ะฟัะพัะธะปั ัะฐะฑะพัะฐะตั ั ะฐะดะผะธะฝัะบะธะผะธ ะฟัะฐะฒะฐะผะธ! ๐ฅ

### ะะพัะปะตะดััะฒะธั:

- โ **Security issue** โ ะฝะตะฟัะฐะฒะธะปัะฝัะน ะบะปัั ะผะพะถะตั ะดะฐัั ะฑะพะปััะต ะฟัะฐะฒ
- โ **ะกััะพะณะฐั ะฟัะพะฒะตัะบะฐ ะฝะต ัะฐะฑะพัะฐะตั** โ ะตัะปะธ ะบะปัั ะฝะต ะฝะฐะนะดะตะฝ, ะธัะฟะพะปัะทัะตััั ะทะฐะบััะธัะพะฒะฐะฝะฝัะน
- โ **ะะตะฟัะตะดัะบะฐะทัะตะผะพะต ะฟะพะฒะตะดะตะฝะธะต** โ ะทะฐะฒะธัะธั ะพั ะฟะพััะดะบะฐ ะฒัะทะพะฒะพะฒ
- โ **ะกะปะพะถะฝะพ ะดะตะฑะฐะถะธัั** โ ะฝะตะฟะพะฝััะฝะพ, ะบะฐะบะพะน ะบะปัั ะธัะฟะพะปัะทัะตััั

---

## โ ะะตัะตะฝะธะต: Profile-Based Client Pool

### ะะพะฒะฐั ะฐััะธัะตะบัััะฐ

```
MCP Tool โ args.profile (profileName) โ Manager(profileName) โ getDockerClientForProfile(profileName)
                                                                        โ
                                                            Pool ะบัั ะฟะพ PROFILE NAME โ
```

### ะัะตะธะผััะตััะฒะฐ:

1. โ **ะะพััะตะบัะฝะพััั** โ ะบะฐะถะดัะน ะฟัะพัะธะปั = ัะฝะธะบะฐะปัะฝัะน ะบะปะธะตะฝั
2. โ **ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั** โ ััะฝะฝะตะปั ะฟะตัะตะธัะฟะพะปัะทัะตััั ะดะปั ะพะดะฝะพะณะพ ะฟัะพัะธะปั
3. โ **ะะตะทะพะฟะฐัะฝะพััั** โ ะฝะตั ะบะพะฝัะปะธะบัะพะฒ ะผะตะถะดั ะบะปััะฐะผะธ
4. โ **ะฏะฒะฝะพััั** โ ะฟัะพัะธะปั "prod-admin" ะฒัะตะณะดะฐ ะธัะฟะพะปัะทัะตั ัะฒะพะน ะบะปะธะตะฝั
5. โ **ะะฐัััะฐะฑะธััะตะผะพััั** โ ะผะพะถะฝะพ ัะฐะฑะพัะฐัั ั N ะฟัะพัะธะปัะผะธ ะฟะฐัะฐะปะปะตะปัะฝะพ

---

## ๐ ะะปะฐะฝ ัะตัะฐะบัะพัะธะฝะณะฐ

### Phase 1: ะะพะดะณะพัะพะฒะบะฐ (1-2 ัะฐัะฐ)

#### 1.1. ะะฝะฐะปะธะท ะทะฐะฒะธัะธะผะพััะตะน

**ะะฐะดะฐัะฐ:** ะะฐะนัะธ ะฒัะต ะผะตััะฐ, ะณะดะต ะธัะฟะพะปัะทัะตััั `getDockerClient(sshConfig)`

```bash
grep -r "getDockerClient(" src/
grep -r "new.*Manager(" src/tools/
grep -r "constructor.*sshConfig" src/managers/
```

**ะะถะธะดะฐะตะผัะต ัะฐะนะปั:**
- `src/managers/container-manager.ts`
- `src/managers/compose-manager.ts`
- `src/managers/env-manager.ts` (ะตัะปะธ ะธัะฟะพะปัะทัะตั SSH)
- `src/adapters/postgresql.ts`
- `src/adapters/redis.ts`
- `src/adapters/sqlite.ts`

#### 1.2. ะะพะบัะผะตะฝัะฐัะธั ัะตะบััะตะณะพ flow

**ะะปั ะบะฐะถะดะพะณะพ ะผะตะฝะตะดะถะตัะฐ ะดะพะบัะผะตะฝัะธัะพะฒะฐัั:**
- ะะฐะบ ะฟัะธะฝะธะผะฐะตั `sshConfig` ะฒ ะบะพะฝััััะบัะพัะต
- ะะฐะบ ัะพะทะดะฐะตั `DockerClient`
- ะะฐะบะธะต ะผะตัะพะดั ะธัะฟะพะปัะทััั remote/local ะปะพะณะธะบั

#### 1.3. ะกะพะทะดะฐัั ัะตััั ะดะปั ัะตะบััะตะณะพ ะฟะพะฒะตะดะตะฝะธั

**ะัะธัะธัะฝัะต ััะตะฝะฐัะธะธ:**
- ะะพะบะฐะปัะฝัะน Docker (profile: undefined ะธะปะธ "local")
- ะฃะดะฐะปะตะฝะฝัะน Docker ั ะฟัะพัะธะปะตะผ
- ะะตัะตะบะปััะตะฝะธะต ะผะตะถะดั ะฟัะพัะธะปัะผะธ
- ะะฒะฐ ะฟัะพัะธะปั ั ะพะดะฝะธะผ host

---

### Phase 2: ะะตัะฐะบัะพัะธะฝะณ Managers (3-4 ัะฐัะฐ)

#### 2.1. ContainerManager

**ะคะฐะนะป:** `src/managers/container-manager.ts`

**ะะทะผะตะฝะตะฝะธั:**

```typescript
// ะะซะะ:
export class ContainerManager {
  private docker: Docker;
  private dockerClient: DockerClient;
  private isRemote: boolean;

  constructor(sshConfig?: SSHConfig | null) {
    this.isRemote = !!sshConfig;
    this.dockerClient = getDockerClient(sshConfig);
    this.docker = this.dockerClient.getClient();
  }
}

// ะกะขะะะะข:
export class ContainerManager {
  private docker: Docker;
  private dockerClient: DockerClient;
  private isRemote: boolean;

  constructor(profileName?: string) {
    this.dockerClient = getDockerClientForProfile(profileName);
    this.isRemote = this.dockerClient.isRemote;
    this.docker = this.dockerClient.getClient();
  }
}
```

**ะขะตััั:**
- โ Local profile ัะพะทะดะฐะตั ะปะพะบะฐะปัะฝัะน ะบะปะธะตะฝั
- โ Remote profile ัะพะทะดะฐะตั SSH ััะฝะฝะตะปั
- โ ะะฒะฐ ัะฐะทะฝัั ะฟัะพัะธะปั = ะดะฒะฐ ัะฐะทะฝัั ะบะปะธะตะฝัะฐ
- โ ะะพะฒัะพัะฝัะน ะฒัะทะพะฒ ั ัะตะผ ะถะต ะฟัะพัะธะปะตะผ = ะฟะตัะตะธัะฟะพะปัะทะพะฒะฐะฝะธะต ะบะปะธะตะฝัะฐ

#### 2.2. ComposeManager

**ะคะฐะนะป:** `src/managers/compose-manager.ts`

**ะะฝะฐะปะพะณะธัะฝัะต ะธะทะผะตะฝะตะฝะธั ะบะพะฝััััะบัะพัะฐ**

#### 2.3. EnvManager

**ะคะฐะนะป:** `src/managers/env-manager.ts`

**ะัะพะฒะตัะธัั:** ะัะฟะพะปัะทัะตั ะปะธ SSH? ะัะปะธ ะฝะตั โ ะฝะต ััะพะณะฐัั.

---

### Phase 3: ะะตัะฐะบัะพัะธะฝะณ Tools (2-3 ัะฐัะฐ)

#### 3.1. ContainerTools

**ะคะฐะนะป:** `src/tools/container-tools.ts`

**ะะทะผะตะฝะตะฝะธั:**

```typescript
// ะะซะะ:
private async handleList(args: any) {
  const sshConfig = resolveSSHConfig(args);
  const containerManager = new ContainerManager(sshConfig);
  // ...
}

// ะกะขะะะะข:
private async handleList(args: any) {
  const containerManager = new ContainerManager(args.profile);
  // ...
}
```

**ะะฑะฝะพะฒะธัั ะฒัะต ะผะตัะพะดั:**
- `handleList()`
- `handleStart()`
- `handleStop()`
- `handleRestart()`
- `handleLogs()`
- `handleComposeUp()`
- `handleComposeDown()`
- `handleResourceList()`
- `handleStats()`

#### 3.2. ExecutorTool

**ะคะฐะนะป:** `src/tools/executor-tool.ts`

**ะะฝะฐะปะพะณะธัะฝัะต ะธะทะผะตะฝะตะฝะธั**

#### 3.3. DatabaseTools

**ะคะฐะนะป:** `src/tools/database-tools.ts`

**ะัะพะฒะตัะธัั:** ะะฐะบ ัะพะทะดะฐัััั database adapters?

---

### Phase 4: ะะตัะฐะบัะพัะธะฝะณ Database Adapters (2-3 ัะฐัะฐ)

#### 4.1. ะะฝะฐะปะธะท ัะตะบััะตะน ะฐััะธัะตะบัััั

**ะัะพะฒะตัะธัั ะบะฐะถะดัะน ะฐะดะฐะฟัะตั:**
- PostgreSQLAdapter
- RedisAdapter
- SQLiteAdapter

**ะะฐะบ ะพะฝะธ ะฟะพะปััะฐัั Docker ะบะปะธะตะฝั?**

#### 4.2. ะะฐัะธะฐะฝัั ัะตัะตะฝะธั:

**ะะฐัะธะฐะฝั A:** ะะดะฐะฟัะตัั ะฟัะธะฝะธะผะฐัั `profileName`

```typescript
export class PostgreSQLAdapter {
  constructor(
    serviceName: string,
    projectDir: string,
    composeFile: string,
    projectName: string,
    profileName?: string  // โ ะะพะฑะฐะฒะธัั
  ) {
    // ...
  }
}
```

**ะะฐัะธะฐะฝั B:** ะะดะฐะฟัะตัั ะฟัะธะฝะธะผะฐัั ะณะพัะพะฒัะน `DockerClient`

```typescript
export class PostgreSQLAdapter {
  constructor(
    serviceName: string,
    projectDir: string,
    composeFile: string,
    projectName: string,
    dockerClient: DockerClient  // โ ะะตัะตะดะฐัั ะณะพัะพะฒัะน ะบะปะธะตะฝั
  ) {
    // ...
  }
}
```

**ะะตะบะพะผะตะฝะดะฐัะธั:** ะะฐัะธะฐะฝั A (profileName) โ ะฑะพะปะตะต ัะฒะฝัะน ะธ ะฟัะพัะต ัะตััะธัะพะฒะฐัั

---

### Phase 5: ะฃะดะฐะปะตะฝะธะต ััะฐัะพะณะพ ะบะพะดะฐ (1 ัะฐั)

#### 5.1. ะฃะดะฐะปะธัั ััะฐััั ัะธััะตะผั

```typescript
// docker-client.ts

// ะฃะะะะะขะฌ:
let dockerClientInstance: DockerClient | null = null;

export function getDockerClient(sshConfig?: SSHConfig | null): DockerClient {
  // ะัั ะปะพะณะธะบะฐ ั singleton
}

export function resetDockerClient(): void { ... }
export function cleanupDockerClient(): void { ... }
```

#### 5.2. ะะตัะตะธะผะตะฝะพะฒะฐัั ััะฝะบัะธั

```typescript
// ะะซะะ:
export function getDockerClientForProfile(profileName?: string): DockerClient

// ะกะขะะะะข (ะพะฟัะธะพะฝะฐะปัะฝะพ):
export function getDockerClient(profileName?: string): DockerClient
```

#### 5.3. ะะฑะฝะพะฒะธัั ะธะผะฟะพััั

```typescript
// ะฃะดะฐะปะธัั ะฝะตะธัะฟะพะปัะทัะตะผัะต ะธะผะฟะพััั resolveSSHConfig ะฒะพ ะฒัะตั tools
```

---

### Phase 6: ะะฑะฝะพะฒะปะตะฝะธะต ัะตััะพะฒ (2-3 ัะฐัะฐ)

#### 6.1. Unit ัะตััั

**ะะฑะฝะพะฒะธัั ัะฐะนะปั:**
- `tests/unit/utils/docker-client.test.ts`
- `tests/unit/managers/container-manager.test.ts`
- `tests/unit/tools/container-tools.test.ts`

**ะะพะฒัะต ัะตัั-ะบะตะนัั:**
- Profile pool ะบััะธัะพะฒะฐะฝะธะต
- ะะฒะฐ ะฟัะพัะธะปั ั ะพะดะฝะธะผ host
- ะะตัะตะบะปััะตะฝะธะต ะผะตะถะดั ะฟัะพัะธะปัะผะธ

#### 6.2. E2E ัะตััั

**ะะฑะฝะพะฒะธัั:**
- `tests/e2e/categories/profile-parameter.test.ts`

**ะะพะฑะฐะฒะธัั ััะตะฝะฐัะธะธ:**
- ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะดะฒัั ะฟัะพัะธะปะตะน ะฟะพะดััะด
- ะัะพะฒะตัะบะฐ ะฟะตัะตะธัะฟะพะปัะทะพะฒะฐะฝะธั ััะฝะฝะตะปะตะน

#### 6.3. ะะฝัะตะณัะฐัะธะพะฝะฝัะต ัะตััั

**ะกะพะทะดะฐัั ัะตัั ะดะปั ะฑะฐะณัะธะบัะฐ:**

```typescript
describe('Profile Client Pool Bug Fix', () => {
  it('should use different clients for different profiles with same host', async () => {
    // Setup: ะดะฒะฐ ะฟัะพัะธะปั ั ะพะดะฝะธะผ host, ัะฐะทะฝัะผะธ ะบะปััะฐะผะธ
    const profiles = {
      'test-key-1': { host: '...',  privateKeyPath: '~/.ssh/key1' },
      'test-key-2': { host: '...', privateKeyPath: '~/.ssh/key2' }
    };
    
    // Act: ะฒัะทะฒะฐัั ะพะฑะฐ ะฟัะพัะธะปั
    const client1 = getDockerClient('test-key-1');
    const client2 = getDockerClient('test-key-2');
    
    // Assert: ัะฐะทะฝัะต ะบะปะธะตะฝัั
    expect(client1).not.toBe(client2);
  });
});
```

---

### Phase 7: ะะพะบัะผะตะฝัะฐัะธั (1 ัะฐั)

#### 7.1. ะะฑะฝะพะฒะธัั ARCHITECTURE.md

**ะะพะฑะฐะฒะธัั ัะตะบัะธั:**
- Profile-Based Client Pool
- ะะธะฐะณัะฐะผะผะฐ ะฝะพะฒะพะณะพ flow
- ะัะตะธะผััะตััะฒะฐ ะฝะพะฒะพะน ะฐััะธัะตะบัััั

#### 7.2. ะะฑะฝะพะฒะธัั CHANGELOG.md

```markdown
## [1.4.0] - 2026-01-XX

### Changed

#### ๐๏ธ Architecture - Profile-Based Docker Client Pool

- **Breaking Change**: Managers ัะตะฟะตัั ะฟัะธะฝะธะผะฐัั `profileName` ะฒะผะตััะพ `sshConfig`
- **Bug Fix**: ะัะฟัะฐะฒะปะตะฝ ะฑะฐะณ ั ะบััะธัะพะฒะฐะฝะธะตะผ ะฟะพ host (ัะฐะทะฝัะต ะฟัะพัะธะปะธ ั ะพะดะฝะธะผ host)
- **Performance**: ะขัะฝะฝะตะปะธ ะฟะตัะตะธัะฟะพะปัะทััััั ะบะพััะตะบัะฝะพ ะดะปั ะบะฐะถะดะพะณะพ ะฟัะพัะธะปั
- **Security**: ะะฐะถะดัะน ะฟัะพัะธะปั ะณะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพ ะธัะฟะพะปัะทัะตั ัะฒะพะน SSH ะบะปัั

#### Migration Guide

**If you use managers directly in your code:**

```typescript
// OLD:
const sshConfig = resolveSSHConfig({ profile: 'prod' });
const manager = new ContainerManager(sshConfig);

// NEW:
const manager = new ContainerManager('prod');
```

**For MCP tools users:** No changes required (automatic)
```

#### 7.3. ะะฑะฝะพะฒะธัั DEVELOPER_ARCHITECTURE.md

**ะะพะฑะฐะฒะธัั:**
- ะะฐะบ ัะฐะฑะพัะฐะตั profile pool
- ะะพะณะดะฐ ัะพะทะดะฐะตััั ะฝะพะฒัะน ะบะปะธะตะฝั
- ะะพะณะดะฐ ะฟะตัะตะธัะฟะพะปัะทัะตััั ัััะตััะฒัััะธะน

---

### Phase 8: ะะฑะฝะพะฒะปะตะฝะธะต ะฒะตััะธะธ ะธ ัะตะปะธะท (30 ะผะธะฝัั)

#### 8.1. ะะตััะธั

```json
// package.json
{
  "version": "1.4.0"  // ะัะปะพ: 1.3.2
}
```

**ะะฑะพัะฝะพะฒะฐะฝะธะต:** Minor version (1.4.0) โ breaking change ะฒ API ะผะตะฝะตะดะถะตัะพะฒ

#### 8.2. npm install + build

```bash
npm install
npm run build
npm run test
```

#### 8.3. Git commit

```bash
git add .
git commit -m "refactor: migrate to profile-based Docker client pool

BREAKING CHANGE: Managers now accept profileName instead of sshConfig

- Fix: SSH client caching bug (different profiles with same host)
- Perf: Proper tunnel reuse per profile
- Security: Each profile uses its own SSH key

Closes #BUG-XXX"
```

---

## ๐ ะัะตะฝะบะฐ ะฒัะตะผะตะฝะธ

| Phase | ะะฐะดะฐัะฐ | ะัะตะผั | ะัะธะพัะธัะตั |
|-------|--------|-------|-----------|
| 1 | ะะพะดะณะพัะพะฒะบะฐ | 1-2 ัะฐัะฐ | HIGH |
| 2 | ะะตัะฐะบัะพัะธะฝะณ Managers | 3-4 ัะฐัะฐ | HIGH |
| 3 | ะะตัะฐะบัะพัะธะฝะณ Tools | 2-3 ัะฐัะฐ | HIGH |
| 4 | ะะตัะฐะบัะพัะธะฝะณ Adapters | 2-3 ัะฐัะฐ | MEDIUM |
| 5 | ะฃะดะฐะปะตะฝะธะต ััะฐัะพะณะพ ะบะพะดะฐ | 1 ัะฐั | LOW |
| 6 | ะขะตััั | 2-3 ัะฐัะฐ | HIGH |
| 7 | ะะพะบัะผะตะฝัะฐัะธั | 1 ัะฐั | MEDIUM |
| 8 | ะะตะปะธะท | 30 ะผะธะฝัั | HIGH |
| **ะะขะะะ** | **13-17 ัะฐัะพะฒ** | **~2 ัะฐะฑะพัะธั ะดะฝั** |

---

## ๐ฏ ะัะธัะตัะธะธ ััะฟะตัะฐ

### ะคัะฝะบัะธะพะฝะฐะปัะฝัะต

- โ ะะฒะฐ ะฟัะพัะธะปั ั ะพะดะฝะธะผ host ะธัะฟะพะปัะทััั ัะฐะทะฝัะต ะบะปะธะตะฝัั
- โ ะกััะพะณะฐั ะฟัะพะฒะตัะบะฐ SSH ะบะปััะตะน ัะฐะฑะพัะฐะตั ะดะปั ะฒัะตั ะฟัะพัะธะปะตะน
- โ ะขัะฝะฝะตะปะธ ะฟะตัะตะธัะฟะพะปัะทััััั ะบะพััะตะบัะฝะพ
- โ ะัะต E2E ัะตััั ะฟัะพัะพะดัั
- โ ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั ะฝะต ัััะดัะธะปะฐัั

### ะะตััะฝะบัะธะพะฝะฐะปัะฝัะต

- โ ะะพะด ะฟัะพัะต ะธ ะฟะพะฝััะฝะตะต
- โ ะะตั ะดัะฑะปะธัะพะฒะฐะฝะธั ะปะพะณะธะบะธ
- โ ะะพะบัะผะตะฝัะฐัะธั ะพะฑะฝะพะฒะปะตะฝะฐ
- โ Migration guide ะฝะฐะฟะธัะฐะฝ

---

## ๐จ ะะธัะบะธ ะธ ะผะธัะธะณะฐัะธั

### ะะธัะบ 1: Breaking change ะดะปั ะฒะฝะตัะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปะตะน

**ะะตัะพััะฝะพััั:** LOW (API ะผะตะฝะตะดะถะตัะพะฒ โ internal)  
**ะะธัะธะณะฐัะธั:** 
- Migration guide ะฒ CHANGELOG
- ะัะธะผะตัั ะฒ ะดะพะบัะผะตะฝัะฐัะธะธ
- ะะฑัะฐัะฝะฐั ัะพะฒะผะตััะธะผะพััั ัะตัะตะท deprecated ะผะตัะพะด (ะพะฟัะธะพะฝะฐะปัะฝะพ)

### ะะธัะบ 2: ะัะพะฟััะตะฝะฝัะต ะผะตััะฐ ะธัะฟะพะปัะทะพะฒะฐะฝะธั ััะฐัะพะณะพ API

**ะะตัะพััะฝะพััั:** MEDIUM  
**ะะธัะธะณะฐัะธั:**
- ะะพะปะฝัะน grep ะฟะพ ะบะพะดะพะฒะพะน ะฑะฐะทะต
- TypeScript ะฟะพะบะฐะถะตั ะพัะธะฑะบะธ ะบะพะผะฟะธะปััะธะธ
- E2E ัะตััั ะฟะพะบัะพัั ะพัะฝะพะฒะฝัะต ััะตะฝะฐัะธะธ

### ะะธัะบ 3: ะะตะณัะตััะธั ะฒ ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ

**ะะตัะพััะฝะพััั:** LOW  
**ะะธัะธะณะฐัะธั:**
- ะะตะฝัะผะฐัะบะธ ะดะพ ะธ ะฟะพัะปะต
- ะัะพัะธะปะธัะพะฒะฐะฝะธะต SSH tunnel creation
- E2E ัะตััั ั ัะฐะนะผะฐััะฐะผะธ

### ะะธัะบ 4: ะัะพะฑะปะตะผั ั cleanup ััะฝะฝะตะปะตะน

**ะะตัะพััะฝะพััั:** MEDIUM  
**ะะธัะธะณะฐัะธั:**
- ะขะตััั ะฝะฐ cleanup ะฟัะธ ะทะฐะฒะตััะตะฝะธะธ ัะตัะฒะตัะฐ
- ะะพะฝะธัะพัะธะฝะณ "ะฒะธัััะธั" SSH ะฟัะพัะตััะพะฒ
- ะะพะบัะผะตะฝัะฐัะธั ะฟะพ graceful shutdown

---

## ๐ Checklist

### ะะพะดะณะพัะพะฒะบะฐ
- [ ] ะกะพะทะดะฐัั feature branch: `refactor/profile-client-pool`
- [ ] ะัะพะฒะตัะธัั ะฒัะต ัะตััั ะฟัะพัะพะดัั ะฝะฐ main
- [ ] ะกะพะทะดะฐัั backup ัะตะบััะตะน ะฒะตััะธะธ

### ะะฐะทัะฐะฑะพัะบะฐ
- [ ] Phase 1: ะะฝะฐะปะธะท ะทะฐะฒะธัะธะผะพััะตะน
- [ ] Phase 2: ะะตัะฐะบัะพัะธะฝะณ Managers
- [ ] Phase 3: ะะตัะฐะบัะพัะธะฝะณ Tools
- [ ] Phase 4: ะะตัะฐะบัะพัะธะฝะณ Adapters
- [ ] Phase 5: ะฃะดะฐะปะตะฝะธะต ััะฐัะพะณะพ ะบะพะดะฐ
- [ ] Phase 6: ะะฑะฝะพะฒะปะตะฝะธะต ัะตััะพะฒ
- [ ] Phase 7: ะะพะบัะผะตะฝัะฐัะธั
- [ ] Phase 8: ะะตะปะธะท

### ะขะตััะธัะพะฒะฐะฝะธะต
- [ ] Unit ัะตััั ะฟัะพัะพะดัั
- [ ] E2E ัะตััั ะฟัะพัะพะดัั
- [ ] ะะฝัะตะณัะฐัะธะพะฝะฝัะต ัะตััั ะฟัะพัะพะดัั
- [ ] ะััะฝะพะต ัะตััะธัะพะฒะฐะฝะธะต ั ะดะฒัะผั ะฟัะพัะธะปัะผะธ
- [ ] ะัะพะฒะตัะบะฐ ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ

### ะะพะบัะผะตะฝัะฐัะธั
- [ ] CHANGELOG.md ะพะฑะฝะพะฒะปะตะฝ
- [ ] ARCHITECTURE.md ะพะฑะฝะพะฒะปะตะฝ
- [ ] DEVELOPER_ARCHITECTURE.md ะพะฑะฝะพะฒะปะตะฝ
- [ ] Migration guide ะฝะฐะฟะธัะฐะฝ

### ะะตะปะธะท
- [ ] ะะตััะธั ะพะฑะฝะพะฒะปะตะฝะฐ
- [ ] Build ััะฟะตัะฝะพ
- [ ] Git commit & push
- [ ] PR ัะพะทะดะฐะฝ (ะตัะปะธ ะบะพะผะฐะฝะดะฝะฐั ัะฐะทัะฐะฑะพัะบะฐ)
- [ ] npm publish (ะตัะปะธ ะฟัะฑะปะธัะฝัะน ะฟะฐะบะตั)

---

## ๐ ะะพะฟะพะปะฝะธัะตะปัะฝัะต ะผะฐัะตัะธะฐะปั

### ะะธะฐะณัะฐะผะผั

#### ะขะตะบััะธะน flow (ั ะฑะฐะณะพะผ)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ MCP Tool: docker_container_list({ profile: "prod-admin" }) โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
              resolveSSHConfig(args)
                         โ
    sshConfig = { host: "prod.com", key: "~/.ssh/admin" }
                         โ
          new ContainerManager(sshConfig)
                         โ
             getDockerClient(sshConfig)
                         โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ Singleton ะบัั ะฟะพ HOST              โ
        โ Key: "prod.com"                    โ
        โ Value: DockerClient (ั admin key) โ โ ะััะธััะตััั!
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                    Result โ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ MCP Tool: docker_container_list({ profile: "prod-readonly" })โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
              resolveSSHConfig(args)
                         โ
    sshConfig = { host: "prod.com", key: "~/.ssh/readonly" }
                         โ
          new ContainerManager(sshConfig)
                         โ
             getDockerClient(sshConfig)
                         โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ Singleton ะบัั ะฟะพ HOST              โ
        โ Key: "prod.com"                    โ
        โ Value: DockerClient (ั admin key) โ โ ะะะ! ะะพะทะฒัะฐัะฐะตั ััะฐััะน!
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
              Result โ (ะธัะฟะพะปัะทัะตััั admin key!)
```

#### ะะพะฒัะน flow (ะฟัะฐะฒะธะปัะฝัะน)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ MCP Tool: docker_container_list({ profile: "prod-admin" }) โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
          new ContainerManager("prod-admin")
                         โ
        getDockerClientForProfile("prod-admin")
                         โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ Profile Pool ะบัั                       โ
        โ Key: "prod-admin"                      โ
        โ Value: DockerClient (ั admin key) โ  โ โ ะััะธััะตััั!
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                    Result โ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ MCP Tool: docker_container_list({ profile: "prod-readonly" })โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
          new ContainerManager("prod-readonly")
                         โ
        getDockerClientForProfile("prod-readonly")
                         โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ Profile Pool ะบัั                           โ
        โ Key: "prod-readonly"                       โ
        โ Value: DockerClient (ั readonly key) โ   โ โ ะะพะฒัะน ะบะปะธะตะฝั!
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
              Result โ (ะฟัะฐะฒะธะปัะฝัะน ะบะปัั!)
```

---

## ๐ ะกะฒัะทะฐะฝะฝัะต ะดะพะบัะผะตะฝัั

- [ARCHITECTURE.md](./ARCHITECTURE.md) โ ะขะตะบััะฐั ะฐััะธัะตะบัััะฐ
- [DEVELOPER_ARCHITECTURE.md](./DEVELOPER_ARCHITECTURE.md) โ ะะตัะฐะปะธ ัะตะฐะปะธะทะฐัะธะธ
- [BUGS_PROFILE_SSH.md](./BUGS_PROFILE_SSH.md) โ ะััะพัะธั ะฑะฐะณะพะฒ ั ะฟัะพัะธะปัะผะธ
- [REMOTE_DOCKER.md](./REMOTE_DOCKER.md) โ ะะฐะฑะพัะฐ ั ัะดะฐะปะตะฝะฝัะผ Docker

---

## ๐ ะะพะฝัะฐะบัั

**ะะฒัะพั ะฟะปะฐะฝะฐ:** AI Assistant  
**ะะตะฒััะฒะตั:** @hypnosis  
**ะะฐัะฐ:** 2026-01-12

---

**ะกัะฐััั:** ๐ ะะพัะพะฒ ะบ ะฒัะฟะพะปะฝะตะฝะธั  
**ะกะปะตะดัััะธะน ัะฐะณ:** ะกะพะทะดะฐัั ะฝะพะฒัะน agent/ัะฐั ะดะปั ะฒัะฟะพะปะฝะตะฝะธั ัะตัะฐะบัะพัะธะฝะณะฐ
